<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>18: Advent of Code</title>
</head>
<body>
<script>
    // The `--no-modules`-generated JS from `wasm-bindgen` attempts to use
    // `WebAssembly.instantiateStreaming` to instantiate the wasm module,
    // but this doesn't work with `file://` urls. This example is frequently
    // viewed by simply opening `index.html` in a browser (with a `file://`
    // url), so it would fail if we were to call this function!
    //
    // Work around this for now by deleting the function to ensure that the
    // `no_modules.js` script doesn't have access to it. You won't need this
    // hack when deploying over HTTP.
    delete WebAssembly.instantiateStreaming;
</script>

<!-- this is the JS generated by the `wasm-bindgen` CLI tool -->
<script src='./pkg/web18.js'></script>
<canvas id="screen"></canvas>
<br/>
<script>
    const LibReady = new Promise((resolve) => window.addEventListener('load', resolve)).then(async () => {
        await wasm_bindgen('./pkg/web18_bg.wasm');
        wasm_bindgen.init();

        console.log("Lib Loaded");
        return wasm_bindgen;
    });

    LibReady.then((lib) => {
        const canvas = document.getElementById('screen');
        const input = document.getElementById('input_area');

        const pixelSize = 10;
        let lumberyard = null;
        let imgByteSize = 0;
        let imgPointer = null;

        let running = false;

        function start(input) {
            stop(lumberyard);
            running = true;

            lumberyard = lib.new_lumberyard(input);

            canvas.width = lib.lumberyard_width(lumberyard) * pixelSize;
            canvas.height = lib.lumberyard_height(lumberyard) * pixelSize;

            const ctx = canvas.getContext('2d');

            // pixels are stored in RGBA
            imgByteSize = canvas.width * canvas.height * 4;
            imgPointer = lib.alloc_vec(imgByteSize);

            const usub = new Uint8ClampedArray(lib.wasm.memory.buffer, imgPointer, imgByteSize);

            const img = new ImageData(usub, canvas.width, canvas.height);

            // run our initial full render
            lib.render_lumberyard(pixelSize, imgPointer, lumberyard, true);

            let last_step = 0;

            function step(timestamp) {
                const progress = timestamp - last_step;

                if (progress > 10) {
                    lib.tick_lumberyard(lumberyard);
                    lib.render_lumberyard(pixelSize, imgPointer, lumberyard, false);

                    if (!running) {
                        console.log("Done!");
                        stop();
                    }

                    last_step = timestamp;

                    if (running) {
                        window.requestAnimationFrame(draw);
                    }
                } else {
                    if (running) {
                        window.requestAnimationFrame(step);
                    }
                }
            }

            function draw() {
                ctx.putImageData(img, 0, 0);
                if (running) {
                    window.requestAnimationFrame(step);
                }
            }

            window.requestAnimationFrame(step);
        }

        function stop() {
            running = false;
            if (lumberyard !== null) {
                lib.delete_lumberyard(lumberyard);
                lumberyard = null;
            }
            if (imgPointer !== null) {
                lib.dealloc_vec(imgPointer, imgByteSize);
                imgPointer = null;
            }
        }

        function input_changed() {
            const input_str = input.value;

            start(input_str);
        }

        input.addEventListener('input', input_changed);

        input_changed();
    });
</script>
<textarea id="input_area">
|##.....|...||..#.........||.##....#|..#.##|..#..#
.|#..|......##.#..|#.#|.||..|...#.|..#.#|#.#|....|
.|.#.....#|.|#.#.|####...|..|.|||..##||....#..##.|
..#....#......|......#.|.#..|.#.||#.|#||.#|.#|.#..
.#..##..##.##|#.....|..||.|.|.|#......#...||.#.||.
.....|||.##.#.#.|.#|#....#..#....|..#......##|.#.|
.#.#.#..|#....|.....#||..#...#.#..#.|##..#..|#|.##
..|..||...||.....||.|.|##.|.|.|.#..#....###.###.#.
.....#.|.#|.|...|.........|..||...#..#....#|....#|
.#.........#.||#....|..##|.#..###......#..###..|..
##||#|.|#.#.||..|#..####|..|.#..|..|...###.....##|
...||.|...##|##||...||#..#|#.|#..|..|.#..#...#....
#|...#..||.|#||.|#.#|....#.|...|#..|..##.#.|..|.|#
...........##..##...|....#|.#...|....#...|.#......
.||#||#.#|||..|#|#..|.....|....#|..#.|#||..#..|#..
||##.....|.#...#||..#.....##|.......|.##|....#|||#
.#|...#.|||#|#....#.|...#|....#.|...|.#|..|....#..
|........#.#..#.|..|.|.....|.|..||....#.|#.|...||#
.||.|..||...||...|.#..|.|......|.#....|||#.|...|..
#...|#.|..#||......#||.|.....|....|##.#.#||.|#...|
..|.##|#....||....#.......#..#|||.|.##||||...|..|.
.....|....#|#.......#|...#|.||.|......|..........#
.|...|##....##...|......|.#.#..||.|.##.|..|..##|..
.|||.......##...#||.....#|.||#|#..##|.....#.|....#
..........|...#|#...|.#..#.#...||.||||...#.#..|###
...##|#|..|##..|#.#.|..##...|....|#..|.|......|...
..#.#|##.....#.###...##...|.|#####|.#.#.|#..|..|..
.|.#.||.#.|#..||#..##.#.#..|.##..|..#||...|...||..
.|.#..|.###..|..#|..#.||##|..|.|#..||#..||.......#
.......#|...#.#.....#.|.|...|||#...|#.#........#..
|.#...#..#..#....|..|.....|.#.|#.#.#.###|.|..|#...
||#.|#|##..###.#...##..##.##.|..#|..|.##...###....
...|.....|...#||###|..##....|.#.|#|.|####.#..#..|.
.|#.###|....|..#.....||.|||.##.||..#|......#..||#.
#|...|..|#.##||.##|.###..|...|.#.#|#|.|.|.#...||..
.|#|#..|#|.||......#...#.#.###...||.|###|.|..|||.#
...|#.|.#.|...|...|..##||..##...#||..|..#.|##|....
..###||#.|.......#.......|.|.....|.#...#.|.|..|.|.
...#|.#.|..##|.##.#.#....#..#....#...#.##.#.|..##|
....|.......|..#|##...|#.|#.|.|...#.|..#.....|#|..
.#|#.|#...|.#|..|##..|..###.||###||#...#....#...##
|.|.|...###|.|.|#.#|#.|..|.#...|..#||...|.|#|..#.#
#.|..||..|.#..||........#|||#......#...|........||
.|||..|.|..|.#|.|###.#..|.|#.|.||....|#.|.##....||
#||..##....#|...#....#.#....|..#|....|..||...#|#..
|..#|..#...|#|#..||....#.#.|...#.|..|.#..#.||#.#|.
#..|..#..#..|.#..||#.|.|#......|##.#.|#..|........
#||.#|..#..........|.||..####.#.##....#.#.|#|#.|..
...#..#...|.###..|#|.|..|.#.|..|..|..|...||#..|.|.
|.#.##...|.|.##.#.#...|..#..|#.#...#...##|||.##.#.
</textarea>
</body>
</html>